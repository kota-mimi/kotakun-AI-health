import { useState, useCallback } from 'react';

interface DailyRecordData {
  date: string;
  weight?: number;
  calories: number;
  protein: number;
  fat: number;
  carbs: number;
  exerciseTime: number;
  exerciseBurned: number;
  exercises: Array<{
    type: string;
    duration: number;
    displayName?: string;
  }>;
  meals: Array<{
    name: string;
    calories: number;
    time?: string;
  }>;
}

interface SecureShareData {
  userId: string; // ãƒ¦ãƒ¼ã‚¶ãƒ¼è­˜åˆ¥ç”¨ãƒãƒƒã‚·ãƒ¥
  timestamp: number; // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆæ™‚åˆ»
  expiresAt: number; // æœ‰åŠ¹æœŸé™
  sessionId: string; // ã‚»ãƒƒã‚·ãƒ§ãƒ³è­˜åˆ¥å­
  data: DailyRecordData; // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿
}

export function useShareRecord() {
  const [isGenerating, setIsGenerating] = useState(false);
  
  // Canvas ã§ç”»åƒç”Ÿæˆï¼ˆåŸºæœ¬çš„ãªãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
  const generateImage = useCallback((recordData: DailyRecordData): Promise<Blob> => {
    return new Promise((resolve, reject) => {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        if (!ctx) {
          throw new Error('Canvas context not available');
        }
        
        // ç”»åƒã‚µã‚¤ã‚º (Instagram Stories: 1080x1920, ä¸€èˆ¬çš„ãªå…±æœ‰: 1200x630)
        canvas.width = 600;
        canvas.height = 800;
        
        // èƒŒæ™¯
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, '#ff6b6b');
        gradient.addColorStop(1, '#ffa726');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
        ctx.fillStyle = 'white';
        ctx.font = 'bold 32px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ãƒ˜ãƒ«ã‚·ãƒ¼ãã‚“è¨˜éŒ²', canvas.width / 2, 80);
        
        // æ—¥ä»˜
        ctx.font = '24px sans-serif';
        ctx.fillText(recordData.date, canvas.width / 2, 120);
        
        // è¨˜éŒ²ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ï¼ˆè§’ä¸¸ï¼‰
        ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
        const drawRoundRect = (x: number, y: number, w: number, h: number, r: number) => {
          ctx.beginPath();
          ctx.moveTo(x + r, y);
          ctx.lineTo(x + w - r, y);
          ctx.quadraticCurveTo(x + w, y, x + w, y + r);
          ctx.lineTo(x + w, y + h - r);
          ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
          ctx.lineTo(x + r, y + h);
          ctx.quadraticCurveTo(x, y + h, x, y + h - r);
          ctx.lineTo(x, y + r);
          ctx.quadraticCurveTo(x, y, x + r, y);
          ctx.closePath();
        };
        
        drawRoundRect(40, 150, canvas.width - 80, 500, 20);
        ctx.fill();
        
        // ãƒ†ã‚­ã‚¹ãƒˆè‰²
        ctx.fillStyle = '#333';
        ctx.textAlign = 'left';
        
        let yPos = 200;
        
        // ã‚«ãƒ­ãƒªãƒ¼æƒ…å ±
        ctx.font = 'bold 24px sans-serif';
        ctx.fillText('ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼', 80, yPos);
        ctx.font = '20px sans-serif';
        ctx.fillText(`${recordData.calories}kcal`, 80, yPos + 30);
        yPos += 70;
        
        // PFCæƒ…å ±
        ctx.font = 'bold 24px sans-serif';
        ctx.fillText('ğŸ– æ „é¤Šãƒãƒ©ãƒ³ã‚¹', 80, yPos);
        ctx.font = '18px sans-serif';
        ctx.fillText(`P: ${recordData.protein}g`, 80, yPos + 30);
        ctx.fillText(`F: ${recordData.fat}g`, 240, yPos + 30);
        ctx.fillText(`C: ${recordData.carbs}g`, 400, yPos + 30);
        yPos += 70;
        
        // ä½“é‡æƒ…å ±
        if (recordData.weight) {
          ctx.font = 'bold 24px sans-serif';
          ctx.fillText('âš–ï¸ ä½“é‡', 80, yPos);
          ctx.font = '20px sans-serif';
          ctx.fillText(`${recordData.weight}kg`, 80, yPos + 30);
          yPos += 70;
        }
        
        // é‹å‹•æƒ…å ±
        ctx.font = 'bold 24px sans-serif';
        ctx.fillText('ğŸ’ª é‹å‹•', 80, yPos);
        if (recordData.exerciseTime > 0) {
          ctx.font = '20px sans-serif';
          ctx.fillText(`${recordData.exerciseTime}åˆ†`, 80, yPos + 30);
          
          // é‹å‹•è©³ç´°ï¼ˆæœ€å¤§3ã¤ã¾ã§ï¼‰
          recordData.exercises.slice(0, 3).forEach((exercise, index) => {
            ctx.font = '16px sans-serif';
            ctx.fillText(`â€¢ ${exercise.displayName || exercise.type}`, 80, yPos + 60 + (index * 25));
          });
        } else {
          ctx.font = '18px sans-serif';
          ctx.fillText('é‹å‹•è¨˜éŒ²ãªã—', 80, yPos + 30);
        }
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        ctx.fillStyle = 'white';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Generated by ãƒ˜ãƒ«ã‚·ãƒ¼ãã‚“', canvas.width / 2, canvas.height - 30);
        
        // Blob ã«å¤‰æ›
        canvas.toBlob((blob) => {
          if (blob) {
            resolve(blob);
          } else {
            reject(new Error('Failed to generate image blob'));
          }
        }, 'image/png', 0.9);
        
      } catch (error) {
        reject(error);
      }
    });
  }, []);
  
  // è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  const formatRecordData = useCallback((
    selectedDate: Date,
    mealData: any,
    exerciseData: any[],
    weightData: any
  ): DailyRecordData => {
    const dateString = selectedDate.toLocaleDateString('ja-JP');
    
    // é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    const allMeals: any[] = [];
    const mealTypes = ['breakfast', 'lunch', 'dinner', 'snack'];
    
    mealTypes.forEach(type => {
      if (mealData[type] && Array.isArray(mealData[type])) {
        mealData[type].forEach((meal: any) => {
          allMeals.push({
            name: meal.name || 'ä¸æ˜',
            calories: meal.calories || 0,
            time: meal.time
          });
        });
      }
    });
    
    // é£Ÿäº‹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ­£ã—ãPFCè¨ˆç®—
    let totalCalories = 0;
    let totalProtein = 0;
    let totalFat = 0;
    let totalCarbs = 0;
    
    mealTypes.forEach(type => {
      if (mealData[type] && Array.isArray(mealData[type])) {
        mealData[type].forEach((meal: any) => {
          totalCalories += meal.calories || 0;
          totalProtein += meal.protein || 0;
          totalFat += meal.fat || 0;
          totalCarbs += meal.carbs || 0;
        });
      }
    });
    
    // é‹å‹•ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    console.log('ğŸ” é‹å‹•ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é–‹å§‹:', {
      selectedDate,
      targetDate: selectedDate.toLocaleDateString('sv-SE'),
      exerciseDataLength: exerciseData.length,
      allExercises: exerciseData.map(ex => ({
        date: ex.date,
        formattedDate: new Date(ex.date).toLocaleDateString('sv-SE'),
        duration: ex.duration,
        caloriesBurned: ex.caloriesBurned
      }))
    });
    
    const todayExercises = exerciseData.filter(exercise => {
      // æ—¥æœ¬æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§æ—¥ä»˜æ¯”è¼ƒï¼ˆä»–ã®ãƒ•ãƒƒã‚¯ã¨åŒã˜ï¼‰
      const targetDateStr = selectedDate.toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' });
      
      let matches = false;
      
      // é‹å‹•ãƒ‡ãƒ¼ã‚¿ã¯æ—¥ä»˜ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã£ã¦ã„ãªã„å ´åˆãŒå¤šã„ã®ã§ã€ä»–ã®æ–¹æ³•ã§åˆ¤å®š
      // 1. exercise.dateãŒã‚ã‚‹å ´åˆ
      if (exercise.date) {
        const exerciseDate = exercise.date;
        
        if (typeof exerciseDate === 'string') {
          matches = exerciseDate === targetDateStr;
          
          if (!matches) {
            const normalizedDate = new Date(exerciseDate).toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' });
            matches = normalizedDate === targetDateStr;
          }
        } else if (exerciseDate instanceof Date) {
          matches = exerciseDate.toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' }) === targetDateStr;
        }
      }
      // 2. timestampãŒã‚ã‚‹å ´åˆ
      else if (exercise.timestamp) {
        const timestampDate = new Date(exercise.timestamp);
        matches = timestampDate.toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' }) === targetDateStr;
      }
      // 3. æ—¥ä»˜æƒ…å ±ãŒãªã„å ´åˆã¯ä»Šæ—¥ã¨ã¿ãªã™ï¼ˆå½“æ—¥å…¥åŠ›ã®é‹å‹•ï¼‰
      else {
        const today = new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Tokyo' });
        matches = targetDateStr === today;
      }
      
      console.log(`ğŸ” é‹å‹•ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒ:`, {
        exerciseId: exercise.id,
        exerciseName: exercise.name,
        exerciseDate: exercise.date,
        exerciseTimestamp: exercise.timestamp,
        targetDate: targetDateStr,
        matches,
        exercise: { duration: exercise.duration, calories: exercise.calories }
      });
      
      return matches;
    });
    
    const totalExerciseTime = todayExercises.reduce((sum, exercise) => {
      // durationï¼ˆæ™‚é–“ï¼‰ ãŒãªã„å ´åˆã¯ 0 ã§è¨ˆç®—ï¼ˆå¼·åº¦ç³»é‹å‹•ã¯æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§ãªã„ï¼‰
      return sum + (exercise.duration || 0);
    }, 0);
    
    // æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼è¨ˆç®—ï¼ˆé‹å‹•ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ï¼‰
    const totalBurnedCalories = todayExercises.reduce((sum, exercise) => {
      const caloriesBurned = exercise.caloriesBurned || 0;
      const calories = exercise.calories || 0;
      const finalCalories = caloriesBurned || calories;
      
      console.log('ğŸ” å€‹åˆ¥é‹å‹•ã‚«ãƒ­ãƒªãƒ¼è©³ç´°:', {
        exerciseName: exercise.name,
        caloriesBurned: caloriesBurned,
        calories: calories,
        finalCalories: finalCalories,
        notes: exercise.notes,
        timestamp: exercise.timestamp
      });
      
      return sum + finalCalories;
    }, 0);
    
    console.log('ğŸ” é‹å‹•é›†è¨ˆçµæœ:', {
      todayExercisesCount: todayExercises.length,
      totalExerciseTime,
      totalBurnedCalories,
      todayExerciseDetails: todayExercises.map(ex => ({
        name: ex.name,
        duration: ex.duration,
        calories: ex.calories,
        caloriesBurned: ex.caloriesBurned,
        notes: ex.notes,
        timestamp: ex.timestamp
      }))
    });
    
    // ä½“é‡ãƒ‡ãƒ¼ã‚¿ï¼ˆç¾åœ¨ã®å®Ÿè£…ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    const todayWeight = weightData?.current ? { weight: weightData.current } : undefined;
    
    const result = {
      date: dateString,
      weight: todayWeight?.weight,
      calories: Math.round(totalCalories),
      protein: Math.round(totalProtein * 10) / 10,
      fat: Math.round(totalFat * 10) / 10,
      carbs: Math.round(totalCarbs * 10) / 10,
      exerciseTime: totalExerciseTime,
      exerciseBurned: totalBurnedCalories,
      exercises: todayExercises.map(ex => ({
        type: ex.type || ex.name || 'é‹å‹•',
        duration: ex.duration || 0,
        displayName: ex.displayName || ex.name || ex.type || 'é‹å‹•'
      })),
      meals: allMeals
    };
    
    return result;
  }, []);
  
  // å…±æœ‰å®Ÿè¡Œ
  const shareRecord = useCallback(async (recordData: DailyRecordData) => {
    try {
      setIsGenerating(true);
      
      // ç”»åƒç”Ÿæˆ
      const imageBlob = await generateImage(recordData);
      const imageFile = new File([imageBlob], `healthy-record-${recordData.date}.png`, { 
        type: 'image/png' 
      });
      
      // Web Share API ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (navigator.canShare && navigator.canShare({ files: [imageFile] })) {
        await navigator.share({
          files: [imageFile],
          title: `ãƒ˜ãƒ«ã‚·ãƒ¼ãã‚“è¨˜éŒ² - ${recordData.date}`,
          text: `${recordData.date}ã®è¨˜éŒ²\nğŸ”¥ ${recordData.calories}kcal\nğŸ’ª ${recordData.exerciseTime}åˆ†é‹å‹•`
        });
        return { success: true, method: 'web-share-api' };
      }
      
      // LIFF Share Target Picker (LINE) - ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æœªå®Ÿè£…ï¼‰
      // if (typeof window !== 'undefined' && window.liff) {
      //   try {
      //     const imageUrl = await uploadImageForLIFF(imageBlob);
      //     await window.liff.shareTargetPicker([{
      //       type: "image",
      //       originalContentUrl: imageUrl,
      //       previewImageUrl: imageUrl
      //     }]);
      //     return { success: true, method: 'liff-share' };
      //   } catch (liffError) {
      //     console.error('LIFF share failed:', liffError);
      //   }
      // }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      return downloadImage(imageBlob, recordData.date);
      
    } catch (error) {
      console.error('Share failed:', error);
      return { success: false, error: error.message };
    } finally {
      setIsGenerating(false);
    }
  }, [generateImage]);
  
  // ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦URLå–å¾—ï¼ˆç°¡æ˜“ç‰ˆãƒ»å¾Œã§æ”¹è‰¯ï¼‰
  const uploadImageForLIFF = async (blob: Blob): Promise<string> => {
    // ä¸€æ™‚çš„ã«ObjectURLã‚’è¿”ã™ï¼ˆæœ¬æ ¼å®Ÿè£…æ™‚ã¯å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
    return URL.createObjectURL(blob);
  };
  
  // ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  const downloadImage = (blob: Blob, date: string) => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `healthy-record-${date.replace(/\//g, '-')}.png`;
    a.click();
    URL.revokeObjectURL(url);
    return { success: true, method: 'download' };
  };
  
  return {
    isGenerating,
    shareRecord,
    formatRecordData,
    generateImage
  };
}