// Flex Message Templates for Counseling Results

export function createCounselingResultFlexMessage(analysis: any, userProfile: any) {
  const nutritionPlan = analysis.nutritionPlan || {};
  const userName = userProfile.name;
  console.log('üîç Flex Template - userProfile.name:', userProfile.name);
  console.log('üîç Flex Template - userName:', userName);
  const age = userProfile.age || 0;
  const gender = userProfile.gender === 'male' ? 'Áî∑ÊÄß' : userProfile.gender === 'female' ? 'Â•≥ÊÄß' : '„Åù„ÅÆ‰ªñ';
  const height = parseFloat(userProfile.height) || 0;
  const currentWeight = parseFloat(userProfile.weight) || 0;
  const targetWeight = parseFloat(userProfile.targetWeight) || currentWeight;
  const weightDifference = Math.round((currentWeight - targetWeight) * 10) / 10;

  // ÁõÆÊ®ô„ÅÆÊó•Êú¨Ë™ûÂ§âÊèõ
  const getGoalText = (goal: string) => {
    switch(goal) {
      case 'weight_loss': return '‰ΩìÈáç„ÇíËêΩ„Å®„Åó„Åü„ÅÑ';
      case 'healthy_beauty': return 'ÂÅ•Â∫∑ÁöÑ„Å´„Ç≠„É¨„Ç§„Å´„Å™„Çä„Åü„ÅÑ';
      case 'weight_gain': return '‰ΩìÈáç„ÇíÂ¢ó„ÇÑ„Åó„Åü„ÅÑ';
      case 'muscle_gain': return 'Á≠ãËÇâ„Çí„Å§„Åë„Åü„ÅÑ';
      case 'lean_muscle': return 'Á≠ãËÇâ„Çí„Å§„Åë„Å™„Åå„ÇâÁó©„Åõ„Åü„ÅÑ';
      case 'fitness_improve': return 'ÈÅãÂãï‰∏çË∂≥Ëß£Ê∂à„Éª‰ΩìÂäõ„ÇíÂêë‰∏ä„Åó„Åü„ÅÑ';
      default: return 'ÂÅ•Â∫∑„Å´„Å™„Çä„Åü„ÅÑ';
    }
  };

  return {
    type: 'flex',
    altText: `${userName}„Åï„Çì„ÅÆ„Ç´„Ç¶„É≥„Çª„É™„É≥„Ç∞ÁµêÊûú`,
    contents: {
      type: 'bubble',
      size: 'kilo',
      action: {
        type: 'uri',
        uri: process.env.NEXT_PUBLIC_LIFF_ID ? `https://liff.line.me/${process.env.NEXT_PUBLIC_LIFF_ID}/dashboard` : `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`
      },
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: '„Ç´„Ç¶„É≥„Çª„É™„É≥„Ç∞ÁµêÊûú',
            weight: 'bold',
            color: '#ffffff',
            size: 'xl',
            align: 'center'
          }
        ],
        backgroundColor: '#1E90FF',
        paddingAll: '16px'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          // BasicInfo: „ÅÇ„Å™„Åü„ÅÆÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '„ÅÇ„Å™„Åü„ÅÆÊÉÖÂ†±',
                weight: 'bold',
                size: 'md',
                color: '#374151',
                margin: 'lg'
              },
              {
                type: 'separator',
                color: '#F3F4F6',
                margin: 'sm'
              }
            ]
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              // ‰∏äÊÆµÔºöÂêçÂâç„ÉªÂπ¥ÈΩ¢
              {
                type: 'box',
                layout: 'horizontal',
                contents: [
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [
                      {
                        type: 'text',
                        text: 'ÂêçÂâç',
                        size: 'xs',
                        color: '#6B7280',
                        align: 'center'
                      },
                      {
                        type: 'text',
                        text: userName,
                        size: 'sm',
                        color: '#111827',
                        align: 'center',
                        margin: 'xs'
                      }
                    ],
                    flex: 1
                  },
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [
                      {
                        type: 'text',
                        text: 'Âπ¥ÈΩ¢',
                        size: 'xs',
                        color: '#6B7280',
                        align: 'center'
                      },
                      {
                        type: 'text',
                        text: `${age}Ê≠≥`,
                        size: 'sm',
                        color: '#111827',
                        align: 'center',
                        margin: 'xs'
                      }
                    ],
                    flex: 1
                  }
                ]
              },
              // ‰∏ãÊÆµÔºöÊÄßÂà•„ÉªË∫´Èï∑
              {
                type: 'box',
                layout: 'horizontal',
                contents: [
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [
                      {
                        type: 'text',
                        text: 'ÊÄßÂà•',
                        size: 'xs',
                        color: '#6B7280',
                        align: 'center'
                      },
                      {
                        type: 'text',
                        text: gender,
                        size: 'sm',
                        color: '#111827',
                        align: 'center',
                        margin: 'xs'
                      }
                    ],
                    flex: 1
                  },
                  {
                    type: 'box',
                    layout: 'vertical',
                    contents: [
                      {
                        type: 'text',
                        text: 'Ë∫´Èï∑',
                        size: 'xs',
                        color: '#6B7280',
                        align: 'center'
                      },
                      {
                        type: 'text',
                        text: `${height}cm`,
                        size: 'sm',
                        color: '#111827',
                        align: 'center',
                        margin: 'xs'
                      }
                    ],
                    flex: 1
                  }
                ],
                margin: 'sm'
              }
            ],
            backgroundColor: '#F9FAFB',
            borderColor: '#F3F4F6',
            borderWidth: '1px',
            cornerRadius: '4px',
            paddingAll: '12px',
            margin: 'sm'
          },

          // BasicInfo: ‰ΩìÈáç„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'text',
            text: '‰ΩìÈáç',
            weight: 'bold',
            size: 'sm',
            color: '#374151',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'ÁèæÂú®',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${currentWeight}kg`,
                    size: 'sm',
                    color: '#111827',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'ÁõÆÊ®ô',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${targetWeight}kg`,
                    size: 'sm',
                    color: '#111827',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'ÁõÆÊ®ô„Åæ„Åß',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: weightDifference > 0 ? `-${Math.abs(weightDifference)}kg` : `+${Math.abs(weightDifference)}kg`,
                    size: 'sm',
                    color: weightDifference > 0 ? '#FC1515' : '#10B981',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              }
            ],
            backgroundColor: '#F9FAFB',
            borderColor: '#F3F4F6',
            borderWidth: '1px',
            cornerRadius: '4px',
            paddingAll: '12px',
            margin: 'sm'
          },

          // DailyTargets: 1Êó•„ÅÆÁõÆÂÆâ„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'separator',
            color: '#F3F4F6',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '1Êó•„ÅÆÁõÆÂÆâ',
                weight: 'bold',
                size: 'md',
                color: '#374151',
                margin: 'md'
              },
              {
                type: 'separator',
                color: '#F3F4F6',
                margin: 'sm'
              }
            ]
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: '„Ç´„É≠„É™„Éº',
                size: 'xs',
                color: '#6B7280',
                align: 'center'
              },
              {
                type: 'text',
                text: `${nutritionPlan.dailyCalories || 2000}kcal`,
                size: 'sm',
                color: '#2563EB',
                align: 'center',
                margin: 'xs'
              }
            ],
            backgroundColor: '#EFF6FF',
            borderColor: '#DBEAFE',
            borderWidth: '1px',
            cornerRadius: '4px',
            paddingAll: '12px',
            margin: 'sm'
          },

          // DailyTargets: PFC„Éê„É©„É≥„Çπ
          {
            type: 'text',
            text: 'PFC„Éê„É©„É≥„Çπ',
            weight: 'bold',
            size: 'sm',
            color: '#374151',
            margin: 'md'
          },
          {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: '„Çø„É≥„Éë„ÇØË≥™',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${(nutritionPlan.macros && nutritionPlan.macros.protein) || 120}g`,
                    size: 'sm',
                    color: '#EF4444',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'ËÑÇË≥™',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${(nutritionPlan.macros && nutritionPlan.macros.fat) || 67}g`,
                    size: 'sm',
                    color: '#F59E0B',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'ÁÇ≠Ê∞¥ÂåñÁâ©',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${(nutritionPlan.macros && nutritionPlan.macros.carbs) || 250}g`,
                    size: 'sm',
                    color: '#10B981',
                    align: 'center',
                    margin: 'xs'
                  }
                ],
                flex: 1
              }
            ],
            backgroundColor: '#F9FAFB',
            borderColor: '#F3F4F6',
            borderWidth: '1px',
            cornerRadius: '4px',
            paddingAll: '12px',
            margin: 'sm'
          },

        ],
        paddingAll: '16px'
      },
    }
  };
}

// Daily Feedback Flex Message Template
export function createDailyFeedbackFlexMessage(
  feedbackData: {
    date: string;
    weight?: { value: number };
    calories: number;
    protein: number;
    fat: number;
    carbs: number;
    exerciseTime: number;
    exercises: Array<{ type: string; duration: number }>;
    mealCount: number;
  },
  feedbackText: string,
  userName?: string
) {
  // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÉÜ„Ç≠„Çπ„Éà„ÇíËß£Êûê„Åó„Å¶„Çª„ÇØ„Ç∑„Éß„É≥ÂàÜ„Åë
  const lines = feedbackText.split('\n').filter(line => line.trim());
  
  // „É°„Ç§„É≥„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊäΩÂá∫
  const summarySection = extractSection(lines, 'üìä ‰ªäÊó•„ÅÆË®òÈå≤', '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  const bodySection = extractSection(lines, 'üéØ ‰ΩìÈáçÁÆ°ÁêÜ', 'üåü Á∑èÂêàË©ï‰æ°');
  const totalSection = extractSection(lines, 'üåü Á∑èÂêàË©ï‰æ°', '');

  // PFCÊØîÁéáË®àÁÆó
  const totalCalories = feedbackData.calories;
  const proteinRatio = totalCalories > 0 ? Math.round((feedbackData.protein * 4 / totalCalories) * 100) : 0;
  const fatRatio = totalCalories > 0 ? Math.round((feedbackData.fat * 9 / totalCalories) * 100) : 0;
  const carbsRatio = totalCalories > 0 ? Math.round((feedbackData.carbs * 4 / totalCalories) * 100) : 0;

  return {
    type: 'flex',
    altText: `${userName ? userName + '„Åï„Çì„ÅÆ' : ''}${feedbackData.date}„ÅÆ1Êó•„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ`,
    contents: {
      type: 'bubble',
      size: 'kilo',
      action: {
        type: 'uri',
        uri: process.env.NEXT_PUBLIC_LIFF_ID ? `https://liff.line.me/${process.env.NEXT_PUBLIC_LIFF_ID}/dashboard` : `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`
      },
      header: {
        type: 'box',
        layout: 'vertical',
        contents: [
          {
            type: 'text',
            text: 'Êú¨Êó•„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„É¨„Éù„Éº„Éà',
            weight: 'bold',
            color: '#ffffff',
            size: 'lg',
            align: 'center'
          },
          {
            type: 'text',
            text: `${feedbackData.date} „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Çµ„Éû„É™„Éº`,
            color: '#ffffff',
            size: 'sm',
            align: 'center',
            margin: 'xs'
          }
        ],
        backgroundColor: '#1E90FF',
        paddingAll: '16px'
      },
      body: {
        type: 'box',
        layout: 'vertical',
        contents: [
          // ‰ªäÊó•„ÅÆË®òÈå≤„Çµ„Éû„É™„Éº
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'üìä ‰ªäÊó•„ÅÆË®òÈå≤',
                weight: 'bold',
                size: 'md',
                color: '#374151',
                margin: 'lg'
              },
              {
                type: 'separator',
                color: '#F3F4F6',
                margin: 'sm'
              }
            ]
          },

          // „Çµ„Éû„É™„Éº„Çª„ÇØ„Ç∑„Éß„É≥ÔºàHeroÈÉ®ÂàÜÔºâ
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: `ÊëÇÂèñ„Ç´„É≠„É™„Éº: ${feedbackData.calories}kcal`,
                size: 'sm',
                color: '#666666',
                margin: 'sm'
              },
              {
                type: 'text',
                text: `PFC„Éê„É©„É≥„Çπ: P ${feedbackData.protein}g / F ${feedbackData.fat}g / C ${feedbackData.carbs}g`,
                size: 'sm',
                color: '#666666',
                margin: 'xs'
              },
              {
                type: 'text',
                text: `ÈÅãÂãïÂÜÖÂÆπ: ${feedbackData.exercises.length > 0 ? feedbackData.exercises.map(ex => `${ex.type} ${ex.duration}ÂàÜ`).join(', ') : 'Êú™ÂÆüÊñΩ'}`,
                size: 'sm',
                color: '#666666',
                margin: 'xs'
              },
              {
                type: 'text',
                text: `Á∑èÈÅãÂãïÊôÇÈñì: ${feedbackData.exerciseTime}ÂàÜ`,
                size: 'sm',
                color: '#666666',
                margin: 'xs'
              }
            ],
            backgroundColor: '#F0F8FF',
            borderColor: '#E6F3FF',
            borderWidth: '1px',
            cornerRadius: '8px',
            paddingAll: '16px',
            margin: 'sm'
          },

          // PFC„Éê„É©„É≥„Çπ
          {
            type: 'text',
            text: 'PFC„Éê„É©„É≥„Çπ',
            weight: 'bold',
            size: 'sm',
            color: '#374151',
            margin: 'md'
          },
          {
            type: 'box',
            layout: 'horizontal',
            contents: [
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'P',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${feedbackData.protein}g`,
                    size: 'sm',
                    color: '#EF4444',
                    align: 'center',
                    margin: 'xs'
                  },
                  {
                    type: 'text',
                    text: `${proteinRatio}%`,
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'F',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${feedbackData.fat}g`,
                    size: 'sm',
                    color: '#F59E0B',
                    align: 'center',
                    margin: 'xs'
                  },
                  {
                    type: 'text',
                    text: `${fatRatio}%`,
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  }
                ],
                flex: 1
              },
              {
                type: 'box',
                layout: 'vertical',
                contents: [
                  {
                    type: 'text',
                    text: 'C',
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  },
                  {
                    type: 'text',
                    text: `${feedbackData.carbs}g`,
                    size: 'sm',
                    color: '#10B981',
                    align: 'center',
                    margin: 'xs'
                  },
                  {
                    type: 'text',
                    text: `${carbsRatio}%`,
                    size: 'xs',
                    color: '#6B7280',
                    align: 'center'
                  }
                ],
                flex: 1
              }
            ],
            backgroundColor: '#F9FAFB',
            borderColor: '#F3F4F6',
            borderWidth: '1px',
            cornerRadius: '4px',
            paddingAll: '12px',
            margin: 'sm'
          },

          // È£ü‰∫ãË©ï‰æ°„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'separator',
            color: '#E0E0E0',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'È£ü‰∫ãÂÜÖÂÆπ„ÅÆË©ï‰æ°',
                weight: 'bold',
                size: 'lg',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: 'ËâØ„Åã„Å£„ÅüÁÇπ',
                weight: 'bold',
                size: 'md',
                color: '#4CAF50',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêËâØ„Åã„Å£„ÅüÁÇπ„Äë', '„ÄêÊîπÂñÑ„ÅåÂøÖË¶Å„Å™ÁÇπ„Äë') || '„ÉªÊ†ÑÈ§ä„Éê„É©„É≥„Çπ„ÇíÊÑèË≠ò„Åó„ÅüÈ£ü‰∫ãÈÅ∏Êäû\n„ÉªÈÅ©Âàá„Å™È£ü‰∫ãÂõûÊï∞„ÅÆÁ∂≠ÊåÅ',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'sm'
              },
              {
                type: 'text',
                text: 'ÊîπÂñÑÁÇπ',
                weight: 'bold',
                size: 'md',
                color: '#FF9800',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêÊîπÂñÑ„ÅåÂøÖË¶Å„Å™ÁÇπ„Äë', '‚ñ† Êú¨Êó•„ÅÆÈÅãÂãïÂÜÖÂÆπ„ÅÆË©ï‰æ°') || '„Éª„Çø„É≥„Éë„ÇØË≥™ÊëÇÂèñÈáè„ÅÆË™øÊï¥\n„ÉªÈ£ü‰∫ã„Çø„Ç§„Éü„É≥„Ç∞„ÅÆË¶ãÁõ¥„Åó',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'sm'
              }
            ]
          },

          // ÈÅãÂãïË©ï‰æ°„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'separator',
            color: '#E0E0E0',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'ÈÅãÂãïÂÜÖÂÆπ„ÅÆË©ï‰æ°',
                weight: 'bold',
                size: 'lg',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: 'ËâØ„Åã„Å£„ÅüÁÇπ',
                weight: 'bold',
                size: 'md',
                color: '#4CAF50',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '‚ñ† Êú¨Êó•„ÅÆÈÅãÂãïÂÜÖÂÆπ„ÅÆË©ï‰æ°', '„ÄêÊîπÂñÑÊèêÊ°à„Äë') || '„ÉªÈÅãÂãïÁøíÊÖ£„ÅÆÁ∂ôÁ∂ö',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'sm'
              },
              {
                type: 'text',
                text: 'ÊîπÂñÑÊèêÊ°à',
                weight: 'bold',
                size: 'md',
                color: '#FF9800',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêÊîπÂñÑÊèêÊ°à„Äë', '‚ñ† ÊòéÊó•„Åã„Çâ„ÅÆÂÖ∑‰ΩìÁöÑ„Ç¢„ÇØ„Ç∑„Éß„É≥') || '„ÉªÈÅãÂãïÂº∑Â∫¶„ÅÆË™øÊï¥\n„Éª„Éê„É©„É≥„Çπ„ÅÆËâØ„ÅÑÈÅãÂãï„Éó„É≠„Ç∞„É©„É†',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'sm'
              }
            ]
          },

          // „Ç¢„ÇØ„Ç∑„Éß„É≥„Çª„ÇØ„Ç∑„Éß„É≥
          {
            type: 'separator',
            color: '#E0E0E0',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'ÊòéÊó•„Åã„Çâ„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥',
                weight: 'bold',
                size: 'lg',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: '„ÄêÂÑ™ÂÖàÂ∫¶ È´ò„Äë',
                weight: 'bold',
                size: 'sm',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêÂÑ™ÂÖàÂ∫¶ È´ò„Äë', '„ÄêÂÑ™ÂÖàÂ∫¶ ‰∏≠„Äë') || '‰∏ªË¶Å„Å™ÊîπÂñÑ„Éù„Ç§„É≥„Éà„Å´ÈõÜ‰∏≠„Åó„Å¶Âèñ„ÇäÁµÑ„ÇÄ',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'xs'
              },
              {
                type: 'text',
                text: '„ÄêÂÑ™ÂÖàÂ∫¶ ‰∏≠„Äë',
                weight: 'bold',
                size: 'sm',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêÂÑ™ÂÖàÂ∫¶ ‰∏≠„Äë', '„ÄêÂÑ™ÂÖàÂ∫¶ ‰Ωé„Äë') || 'È£ü‰∫ã„Éê„É©„É≥„Çπ„ÅÆÂæÆË™øÊï¥',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'xs'
              },
              {
                type: 'text',
                text: '„ÄêÂÑ™ÂÖàÂ∫¶ ‰Ωé„Äë',
                weight: 'bold',
                size: 'sm',
                color: '#1E90FF',
                margin: 'md'
              },
              {
                type: 'text',
                text: extractSectionFromText(feedbackText, '„ÄêÂÑ™ÂÖàÂ∫¶ ‰Ωé„Äë', '') || 'ÈÅãÂãï„É°„Éã„É•„Éº„ÅÆÂ§öÊßòÂåñ',
                size: 'sm',
                color: '#333333',
                wrap: true,
                margin: 'xs'
              }
            ]
          },

          // „Éï„ÉÉ„Çø„ÉºÈÉ®ÂàÜ
          {
            type: 'separator',
            color: '#E0E0E0',
            margin: 'lg'
          },
          {
            type: 'box',
            layout: 'vertical',
            contents: [
              {
                type: 'text',
                text: 'Á∂ôÁ∂ö„ÅåÂäõ„Å´„Å™„Çä„Åæ„Åô„ÄÇÊòéÊó•„ÇÇÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜ‚ú®',
                size: 'sm',
                color: '#666666',
                align: 'center',
                margin: 'md'
              }
            ],
            backgroundColor: '#F5F5F5',
            paddingAll: '12px',
            cornerRadius: '8px'
          }
        ],
        paddingAll: '16px'
      }
    }
  };
}

// „ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÁâπÂÆö„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊäΩÂá∫„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
function extractSection(lines: string[], startMarker: string, endMarker: string): string {
  const startIndex = lines.findIndex(line => line.includes(startMarker));
  if (startIndex === -1) return '';
  
  let endIndex = lines.length;
  if (endMarker) {
    const foundEndIndex = lines.findIndex((line, index) => index > startIndex && line.includes(endMarker));
    if (foundEndIndex !== -1) {
      endIndex = foundEndIndex;
    }
  }
  
  return lines.slice(startIndex + 1, endIndex)
    .filter(line => !line.includes('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'))
    .join('\n')
    .trim();
}

// „ÉÜ„Ç≠„Çπ„Éà„ÇíÊåáÂÆöÊñáÂ≠óÊï∞„ÅßÂàá„ÇäË©∞„ÇÅ„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
function truncateText(text: string, maxLength: number): string {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// „ÉÜ„Ç≠„Çπ„Éà„Åã„ÇâÁâπÂÆö„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÊäΩÂá∫„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞ÔºàÊñáÂ≠óÂàóÁâàÔºâ
function extractSectionFromText(text: string, startMarker: string, endMarker: string): string {
  const lines = text.split('\n').filter(line => line.trim());
  return extractSection(lines, startMarker, endMarker);
}