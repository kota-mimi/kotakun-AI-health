import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const accessToken = process.env.LINE_CHANNEL_ACCESS_TOKEN;
  
  if (!accessToken) {
    return NextResponse.json({ error: 'LINE_CHANNEL_ACCESS_TOKEN is not set' }, { status: 500 });
  }

  try {
    // 1. æ—¢å­˜ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
    await deleteExistingRichMenus(accessToken);

    // 2. æ–°ã—ã„ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
    const richMenuId = await createRichMenu(accessToken);

    // 3. ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    await uploadRichMenuImage(accessToken, richMenuId);

    // 4. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦è¨­å®š
    await setDefaultRichMenu(accessToken, richMenuId);

    return NextResponse.json({ 
      success: true, 
      richMenuId,
      message: 'ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒæ­£å¸¸ã«è¨­å®šã•ã‚Œã¾ã—ãŸï¼' 
    });

  } catch (error: any) {
    console.error('ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json({ 
      error: 'ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ', 
      details: error.message 
    }, { status: 500 });
  }
}

// æ—¢å­˜ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
async function deleteExistingRichMenus(accessToken: string) {
  try {
    const response = await fetch('https://api.line.me/v2/bot/richmenu/list', {
      headers: {
        'Authorization': `Bearer ${accessToken}`,
      },
    });

    const data = await response.json();
    
    if (data.richmenus && data.richmenus.length > 0) {
      for (const menu of data.richmenus) {
        await fetch(`https://api.line.me/v2/bot/richmenu/${menu.richMenuId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${accessToken}`,
          },
        });
        console.log(`æ—¢å­˜ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ ${menu.richMenuId} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
      }
    }
  } catch (error) {
    console.log('æ—¢å­˜ã®ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ï¼ˆç¶šè¡Œï¼‰:', error);
  }
}

// æ–°ã—ã„ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
async function createRichMenu(accessToken: string) {
  const richMenuData = {
    size: {
      width: 2500,
      height: 843
    },
    selected: true,
    name: "å¥åº·ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
    chatBarText: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼",
    areas: [
      {
        bounds: {
          x: 0,
          y: 0,
          width: 833,
          height: 843
        },
        action: {
          type: "uri",
          uri: process.env.NEXT_PUBLIC_LIFF_ID ? `https://liff.line.me/${process.env.NEXT_PUBLIC_LIFF_ID}/dashboard` : `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`
        }
      },
      {
        bounds: {
          x: 833,
          y: 0,
          width: 834,
          height: 843
        },
        action: {
          type: "postback",
          data: "action=record_menu"
        }
      },
      {
        bounds: {
          x: 1667,
          y: 0,
          width: 833,
          height: 843
        },
        action: {
          type: "postback",
          data: "action=ai_advice"
        }
      }
    ]
  };

  const response = await fetch('https://api.line.me/v2/bot/richmenu', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`,
    },
    body: JSON.stringify(richMenuData),
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆå¤±æ•—: ${error}`);
  }

  const result = await response.json();
  console.log(`ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ä½œæˆæˆåŠŸ: ${result.richMenuId}`);
  return result.richMenuId;
}

// ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
async function uploadRichMenuImage(accessToken: string, richMenuId: string) {
  try {
    // ç”Ÿæˆã•ã‚ŒãŸPNGç”»åƒã‚’èª­ã¿è¾¼ã¿
    const fs = require('fs');
    const path = require('path');
    const imagePath = path.join(process.cwd(), 'rich-menu-final.png');
    
    let imageBuffer;
    
    if (fs.existsSync(imagePath)) {
      console.log('ğŸ“¸ ç”Ÿæˆã•ã‚ŒãŸç”»åƒã‚’ä½¿ç”¨:', imagePath);
      imageBuffer = fs.readFileSync(imagePath);
    } else {
      console.log('âš ï¸ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');
      return;
    }
    
    const canvas = imageBuffer;

  const response = await fetch(`https://api-data.line.me/v2/bot/richmenu/${richMenuId}/content`, {
    method: 'POST',
    headers: {
      'Content-Type': 'image/png',
      'Authorization': `Bearer ${accessToken}`,
    },
    body: canvas,
  });

  if (!response.ok) {
    const error = await response.text();
    console.log(`ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—ï¼ˆç¶šè¡Œï¼‰: ${error}`);
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
  } else {
    console.log('ãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ');
  }
  } catch (error) {
    console.error('ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  }
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦è¨­å®š
async function setDefaultRichMenu(accessToken: string, richMenuId: string) {
  const response = await fetch(`https://api.line.me/v2/bot/user/all/richmenu/${richMenuId}`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    const error = await response.text();
    throw new Error(`ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå¤±æ•—: ${error}`);
  }

  console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒªãƒƒãƒãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šæˆåŠŸ');
}